name: CI
on:
  push:
    branches:
      - main
jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Format
        run: deno fmt --check
      - name: Lint
        run: deno lint
      - name: Type-check
        run: deno check --frozen **/*.ts
      - name: Install dependencies
        run: deno install
      - name: Ensure working tree is clean
        run: git diff --exit-code
      - name: Run tests
        run: deno test --permit-no-files
  package_metadata:
    name: Read package name + version from deno.json
    outputs:
      name: ${{ steps.package_metadata.outputs.name }}
      version: ${{ steps.package_metadata.outputs.version }}
      tag: ${{ steps.package_metadata.outputs.tag }}
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Read package name + version from deno.json
        id: package_metadata
        run: |
          if ! jq -e '.name | type == "string"' deno.json > /dev/null; then
            echo "Error: deno.json field .name must be a string"
            exit 1
          fi
          if ! jq -e '.version | type == "string"' deno.json > /dev/null; then
            echo "Error: deno.json field .version must be a string"
            exit 1
          fi
          NAME="$(jq -r '.name' deno.json)"
          VERSION="$(jq -r '.version' deno.json)"
          TAG="v${VERSION}"
          echo "name=$NAME" >> "$GITHUB_OUTPUT"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Package: $NAME"
          echo "Version: $VERSION"
          echo "Tag: $TAG"
  jsr_exists:
    name: Check if package exists on JSR
    needs: package_metadata
    outputs:
      exists: ${{ steps.jsr_exists.outputs.exists }}
    runs-on: ubuntu-latest
    steps:
      - name: Check if package exists on JSR
        id: jsr_exists
        env:
          NAME: ${{ needs.package_metadata.outputs.name }}
          VERSION: ${{ needs.package_metadata.outputs.version }}
        run: |
          URL="https://jsr.io/${NAME}/${VERSION}_meta.json"
          HTTP_STATUS="$(curl -s -o /dev/null -w "%{http_code}" "$URL")"
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "JSR: package ${NAME}@${VERSION} already exists."
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "JSR: package ${NAME}@${VERSION} does not exist."
          else
            echo "Error: unexpected HTTP status $HTTP_STATUS when checking JSR for ${NAME}@${VERSION}"
            exit 1
          fi
  npm_exists:
    name: Check if package exists on NPM
    needs: package_metadata
    outputs:
      exists: ${{ steps.npm_exists.outputs.exists }}
    runs-on: ubuntu-latest
    steps:
      - name: Check if package exists on NPM
        id: npm_exists
        env:
          NAME: ${{ needs.package_metadata.outputs.name }}
          VERSION: ${{ needs.package_metadata.outputs.version }}
        run: |
          URL="https://registry.npmjs.org/${NAME}/${VERSION}"
          HTTP_STATUS="$(curl -s -o /dev/null -w "%{http_code}" "$URL")"
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "NPM: package ${NAME}@${VERSION} already exists."
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "NPM: package ${NAME}@${VERSION} does not exist."
          else
            echo "Error: unexpected HTTP status $HTTP_STATUS when checking NPM for ${NAME}@${VERSION}"
            exit 1
          fi
  dry_run_publish_jsr:
    name: Dry run publish to JSR
    needs: [ci, jsr_exists]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Generate jsr.json
        run: deno run --allow-all scripts/generate-package-manifest.ts --type=jsr | tee jsr.json
      - name: Dry run publish to JSR
        if: needs.jsr_exists.outputs.exists == 'false'
        run: deno publish --config=jsr.json --dry-run
  dry_run_publish_npm:
    name: Dry run publish to NPM
    needs: [ci, npm_exists]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Generate package.json
        run: deno run --allow-all scripts/generate-package-manifest.ts --type=npm | tee package.json
      - name: Install dependencies
        run: deno install
      - name: Build
        run: deno task --eval "tsc --build"
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Dry run publish to NPM
        if: needs.npm_exists.outputs.exists == 'false'
        run: npm publish --dry-run
  github_release:
    name: GitHub release
    needs: [dry_run_publish_jsr, dry_run_publish_npm, package_metadata]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Check if GitHub release exists
        id: release_exists
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.package_metadata.outputs.tag }}
        run: |
          URL="https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}"
          HTTP_STATUS="$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$URL")"
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Release $TAG already exists."
          elif [ "$HTTP_STATUS" = "404" ]; then
            echo "exists=false" >> "$GITHUB_OUTPUT"
            echo "Release $TAG does not exist."
          else
            echo "Error: unexpected HTTP status $HTTP_STATUS when checking release $TAG"
            exit 1
          fi
      - name: Create GitHub release
        if: steps.release_exists.outputs.exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.package_metadata.outputs.tag }}
        run: gh release create "$TAG" --repo "${{ github.repository }}" --target "${{ github.sha }}" --generate-notes
  resolve_tag_commit:
    name: Resolve tag commit
    needs: [github_release, package_metadata]
    outputs:
      sha: ${{ steps.resolve_tag_commit.outputs.sha }}
    runs-on: ubuntu-latest
    steps:
      - name: Resolve tag commit
        id: resolve_tag_commit
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.package_metadata.outputs.tag }}
        run: |
          URL="https://api.github.com/repos/${{ github.repository }}/git/ref/tags/${TAG}"
          RESPONSE="$(curl -sS -w '\n%{http_code}' \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "$URL")"
          HTTP_STATUS="${RESPONSE##*$'\n'}"
          BODY="${RESPONSE%$'\n'*}"
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Error: unexpected HTTP status $HTTP_STATUS when resolving tag $TAG"
            exit 1
          fi
          OBJECT_TYPE="$(echo "$BODY" | jq -r '.object.type')"
          TAG_COMMIT_SHA="$(echo "$BODY" | jq -r '.object.sha')"
          if [ "$OBJECT_TYPE" != "commit" ]; then
            echo "Error: tag $TAG is not a lightweight tag (expected commit, got $OBJECT_TYPE)"
            exit 1
          fi
          echo "sha=$TAG_COMMIT_SHA" >> "$GITHUB_OUTPUT"
          echo "Tag commit SHA: $TAG_COMMIT_SHA"
  publish_jsr:
    name: Publish to JSR
    needs: [jsr_exists, resolve_tag_commit]
    if: needs.jsr_exists.outputs.exists == 'false' && needs.resolve_tag_commit.outputs.sha == github.sha
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Generate jsr.json
        run: deno run --allow-all scripts/generate-package-manifest.ts --type=jsr | tee jsr.json
      - name: Publish to JSR
        run: deno publish --config=jsr.json
  publish_npm:
    name: Publish to NPM
    needs: [npm_exists, resolve_tag_commit]
    if: needs.npm_exists.outputs.exists == 'false' && needs.resolve_tag_commit.outputs.sha == github.sha
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Set up Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: v2.x
      - name: Generate package.json
        run: deno run --allow-all scripts/generate-package-manifest.ts --type=npm | tee package.json
      - name: Install dependencies
        run: deno install
      - name: Build
        run: deno task --eval "tsc --build"
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Publish to NPM
        run: npm publish --provenance --access public
